<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="agent">
	<insert id="insertAgent">
		insert into member
		(member_no, member_email, member_name, member_pwd, phone, status, company_reg_no)
		values(seq_member_no.nextval,
				#{memberEmail},
				#{memberName},
				#{memberPwd},
				#{phone},
				#{status},
				#{companyRegNo})
	</insert>
	
	<select id="selectOneAgent" resultType="agent">
		SELECT * FROM MEMBER WHERE MEMBER_EMAIL = #{memberEmail}
	</select>
	
	<select id="checkMemberEmail" resultType="int">
		select count(*) from member where member_email = #{memberEmail}
	</select>
	<insert id="insertEstateAgent">
		insert into company_info
		values(seq_company_no.nextval,
				#{companyRegNo},
				#{companyName},
				#{companyPhone})
	</insert>
	<select id="checkCompanyCount" resultType="_int">
		select count(*) from company_info where company_reg_no = #{companyRegNo}
	</select>
	<resultMap type="map" id="estate"></resultMap>
	<select id="estateList" resultType="map">
		select e.estate_no, e.business_member_no, e.transaction_type, e.estate_price, e.estate_area, e.address, e.estate_content,
         p.renamed_filename
		from estate e left join (select estate_no, renamed_filename from estate_photo
		                                where rowid in (select min(rowid) from estate_photo group by estate_no))p
		                                on e.estate_no = p.estate_no
		where e.business_member_no is null
		<if test="searchType != null">
			and estate_type like #{searchType}
		</if>
		<if test="searchKeyword != null">
			and address like '%' || #{searchKeyword} || '%'
		</if>
	</select>
	<update id="updateEstate">
		update estate
		set business_member_no = #{memberNo}, business_phone = #{phone}
		where estate_no = #{estateNo}
	</update>
	<select id="estateListEnd" resultMap="estate">
		select e.estate_no, e.transaction_type, e.estate_price, e.estate_area, e.address, e.estate_content,
         p.renamed_filename, nvl(l.period-sysdate, 0) as adate
		from estate e left join (select estate_no, renamed_filename from estate_photo
                                where rowid in (select min(rowid) from estate_photo group by estate_no))p
                                on e.estate_no = p.estate_no
        left join power_link l on e.estate_no = l.estate_no
	</select>
</mapper>